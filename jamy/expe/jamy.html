<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Jamy</title>

<script type="text/javascript" src="envDescription.json"></script>
<script>
var svgNS = "http://www.w3.org/2000/svg";  
var orientationEnum = { "left":"l", "right":"r", "up":"u", "down":"d"};

var gRectangles = {};
var gConnectors = {};
var gSep = "|";

function showEnvList() {
	var envList = envDescription.envList;
	var div = document.getElementById("envList");
	
	div.innerHTML = "";
	for(var i=0; i!=envList.length; i++) {
		var c = document.createElement("input");
		c.type = "button";
		c.value = envList[i];
		c.style.width = "150px";
		
		div.appendChild(c);
		div.appendChild(document.createElement("br"));
	}
}

function drawRectangle(name, connectors, position) {
	
	//draw
	var x = parseInt(position.x);
	var y = parseInt(position.y);
	var h = parseInt(position.h);
	var w = parseInt(position.w);

	var r = document.createElementNS(svgNS, "rect");
	var t = document.createElementNS(svgNS, "text");
	var g = document.createElementNS(svgNS, "g");
	var fontSize = 20;
	
	r.setAttributeNS(null, "x", position.x);
	r.setAttributeNS(null, "y", position.y);
	r.setAttributeNS(null, "width", position.w);
	r.setAttributeNS(null, "height", position.h);
	//r.setAttributeNS(null, "style", "fill:white;stroke:black;stroke-width:5;");
	r.setAttributeNS(null, "style", "fill:white;stroke:black;");
		
	t.setAttributeNS(null, "x", parseInt(position.x)+parseInt(position.w)/2);
	t.setAttributeNS(null, "y", parseInt(position.y)+parseInt(position.h)/2+fontSize/2);
	t.setAttributeNS(null, "font-family", "Verdana");
	t.setAttributeNS(null, "font-size", fontSize);
	t.setAttributeNS(null, "fill", "black");
	t.setAttributeNS(null, "text-anchor", "middle");
	t.appendChild(document.createTextNode(name));

	g.appendChild(r);
	g.appendChild(t);
	addToSvg(g);
	
	// store in context
	var rectangle = {"x":x, "y":y, "w":w, "h":h};
	gRectangles[name] = rectangle;
	
	// add connectors
	if(connectors != null) {
		drawConnectors(rectangle, connectors, name);
	}
}

function addToSvg(o) {
	// todo : ca s'optimise ?
	document.getElementById("mysvg").appendChild(o);
}

function svgDefs() {
	var defs = document.createElementNS(svgNS, "defs");
	var marker = document.createElementNS(svgNS, "marker");
	var markerPath = document.createElementNS(svgNS, "path");
	marker.setAttributeNS(null, "id", "head");
	marker.setAttributeNS(null, "orient", "auto");
	marker.setAttributeNS(null, "markerWidth", "2");
	marker.setAttributeNS(null, "markerHeight", "4");
	marker.setAttributeNS(null, "refX", "2");
	marker.setAttributeNS(null, "refY", "2");
	markerPath.setAttributeNS(null, "d", "M0,0 V4 L2,2 Z");
	markerPath.setAttributeNS(null, "fill", "red");
	marker.appendChild(markerPath);
	defs.appendChild(marker);
	addToSvg(defs);
}

function drawLink(fromRectangle, toConnector) {
	var toX = toConnector.x;
	var toY = toConnector.y;
	
	var fromX = fromRectangle.x;
	var fromY = fromRectangle.y+fromRectangle.h/2;

	var fromOrientation = null;

	// todo : on doit pouvoir faire une matrice de tout ça
	if(toConnector.orientation == "l") {
		if(toConnector.x < fromRectangle.x+fromRectangle.w) {
			fromOrientation = "l";
		}
		else {
			fromOrientation = "r";
		}
	}
	else {
		if(toConnector.x < fromRectangle.x) {
			fromOrientation = "l";
		}
		else {
			fromOrientation = "r";
		}
	}
	
	var fromX = (fromOrientation=="l" ? fromRectangle.x : fromRectangle.x+fromRectangle.w);
	var fromY = (fromRectangle.y+fromRectangle.h/2);
	if(fromOrientation == toConnector.orientation) {
		// C-shape
		var strPath = "M" + fromX + " " + fromY;
		strPath += " H" + (toX+(fromOrientation=="l"?-20:20));
		strPath += " V" + toConnector.y;
		strPath += " H" + toConnector.x;
	}
	else {
		// Z-shape
		var strPath = "M" + fromX + " " + fromY;
		strPath += " H" + ((fromX+toConnector.x)/2);
		strPath += " V" + toConnector.y;
		strPath += " H" + toConnector.x;
	}
	
	var p = document.createElementNS(svgNS, "path");
	p.setAttributeNS(null, "marker-end", "url(#head)");
	p.setAttributeNS(null, "fill", "none");
	p.setAttributeNS(null, "stroke", "blue");
	p.setAttributeNS(null, "stroke-width", "5");
	p.setAttributeNS(null, "d", strPath);
	addToSvg(p);
	
}

function showLinks() {
	/*

	var p = document.createElementNS(svgNS, "path");
	p.setAttributeNS(null, "marker-end", "url(#head)");
	p.setAttributeNS(null, "fill", "none");
	p.setAttributeNS(null, "stroke", "blue");
	p.setAttributeNS(null, "stroke-width", "5");
	p.setAttributeNS(null, "d", "M100 100 H140 V140 H180 V180");

	addToSvg(p);*/
	
	var links = envDescription.links;
	for(var i=0; i!=links.length; i++) {
		var link = links[i];
	
		var fromName = link.from;
		var toName = link.to;
		var toConnectorName = link.connector;

		var fromRectangle = gRectangles[fromName];
		var toConnector = gConnectors[toName+gSep+toConnectorName];
		
		drawLink(fromRectangle, toConnector);
	}

}

function drawConnectors(rectangle, connectors, namePrefix) {
	if(connectors == null) {
		return;
	}

	var width = 8;
	var n = Object.keys(connectors).length;
	
	var orientedConnectors = {};
	for(var i=0; i!=Object.keys(orientationEnum).length; i++) {
		var orientationName = Object.keys(orientationEnum)[i];
		orientedConnectors[orientationName] = [];
	}

	for(var i=0; i!=n; i++) {
		connectorName = Object.keys(connectors)[i];
		connector = connectors[connectorName];
		connector.name = connectorName;
		orientedConnectors[connector.orientation].push(connector);
	}
	
	for(var i=0; i!=Object.keys(orientedConnectors).length; i++) {
		var orientationName = Object.keys(orientedConnectors)[i];
		var orientation = orientationEnum[orientationName];
		var connectorList = orientedConnectors[orientationName]
		
		for(var j=0; j!=connectorList.length; j++) {
			// todo : up and down orientation
			var connector = connectorList[j];
			
			if(orientation == "r") {
				var y = rectangle.y + rectangle.h*(j+1)/(connectorList.length+1);
				var x = rectangle.x + rectangle.w;
			}
			else {
				var y = rectangle.y + rectangle.h*(j+1)/(connectorList.length+1);
				var x = rectangle.x;
			}
			
			drawConnector(namePrefix+gSep+connector.name, 
						x, 
						y, 
						width, 
						orientation)
		}
	}
}

function drawConnector(name, x, y, w, orientation) {
	
	// draw
	var r = document.createElementNS(svgNS, "rect");
	r.setAttributeNS(null, "x", x-w/2);
	r.setAttributeNS(null, "y", y-w/2);
	r.setAttributeNS(null, "width", w);
	r.setAttributeNS(null, "height", w);
	r.setAttributeNS(null, "style", "fill:white;stroke:black;");
	addToSvg(r);
	
	// store in context
	gConnectors[name] = {"x":x, "y":y, "w":w, "orientation":orientation};

}

function showApplication() {
	var application = envDescription.application;
	var modules = application.modules;
	var positioning = envDescription.positioning;

	for(var i=0; i!=Object.keys(modules).length; i++) {
		var moduleName = Object.keys(modules)[i];
		var module = modules[moduleName];
		var position = positioning[moduleName];
		
		drawRectangle(moduleName, module.connectors, position)
	}
}

function showExternalApplications() {
	var externalApplications = envDescription.externalApplications;
	var positioning = envDescription.positioning;

	for(var i=0; i!=Object.keys(externalApplications).length; i++) {
		var externalApplicationName = Object.keys(externalApplications)[i];
		var externalApplication = externalApplications[externalApplicationName];
		var position = positioning[externalApplicationName];
		
		drawRectangle(externalApplicationName, externalApplication.connectors, position);
	}

}

function myBodyOnload() {
	svgDefs();
	showEnvList();
	showApplication();
	showExternalApplications();
	showLinks();

	/*var mysvg = document.getElementById("mysvg");
	
	var mycercle = document.createElementNS(svgNS, "circle");
	mycercle.setAttributeNS(null, "cx", "200");
	mycercle.setAttributeNS(null, "cy", "200");
	mycercle.setAttributeNS(null, "r", "20");
	mycercle.setAttributeNS(null, "stroke", "red");
	mycercle.setAttributeNS(null, "fill", "green");
	mycercle.setAttributeNS(null, "stroke-width", "10");

	var mycercle2 = document.createElementNS(svgNS, "circle");
	mycercle2.setAttributeNS(null, "cx", "100");
	mycercle2.setAttributeNS(null, "cy", "150");
	mycercle2.setAttributeNS(null, "r", "50");
	mycercle2.setAttributeNS(null, "stroke", "grey");
	mycercle2.setAttributeNS(null, "fill", "blue");
	mycercle2.setAttributeNS(null, "stroke-width", "40");
	
	mysvg.appendChild(mycercle);
	mysvg.appendChild(mycercle2);*/
}


</script>
</head>
<body onload="myBodyOnload();">

<table><tr><td style="width:200px;vertical-align:top" >
    <div id="envList"/>

<div>
 autres infos ici
</div>
</td><td>

<svg id="mysvg" height="600" width="900" 
 xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"/>
 
</svg> 

</td></tr></table>

</body>
</html> 