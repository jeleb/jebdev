<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Jamy</title>

<style>

.environmentRadioButton {
	display:none;
}

.environmentRadioButton + label {
	display:block;
	background-color:lightblue;
	font-size:14px;
	font-family:Verdana;
	width:140px;
    border-radius: 5px;
	text-align:center;	
	vertical-align:middle;
    color:black;
}

.environmentRadioButton:checked + label {
   font-weight: bold;
   background-color:darkblue;
   color:white;
}

.environmentLabel {
	height : 25px;
}

.environmentLabel span {
	vertical-align : middle;
}

.detailsTitle {
	font-family:Verdana;
	font-size:14px;
	font-weight:bold;
	margin-top:7px;
	margin-bottom:7px;
}

.detailsTable {
	border:0;
	margin:0;
    border-collapse: collapse;
	width : 100%;
}

.detailsTable td {
	border-color : grey;
	border-width:1px; 
	border-style:solid; 
	padding:3px;
}
</style>


<script>
var envDetails = {};
</script>
<script type="text/javascript" src="envDescription.json"></script>
<script type="text/javascript" src="env_Rec.json"></script>
<script type="text/javascript" src="env_Prod.json"></script>
<script>
var svgNS = "http://www.w3.org/2000/svg";  
var orientationEnum = { "left":"l", "right":"r", "up":"u", "down":"d"};

var gRectangles = {};
var gConnectors = {};
var gSep = "|";

var gSelection = null;

function setSelection(selection, onRefreshFunction) {
	gSelection = { "object":selection, "onrefresh":onRefreshFunction};
}

function refreshSelection() {
	if(gSelection != null) {
		gSelection.onrefresh();
	}
}

function showEnvList() {
	var envList = envDescription.envList;
	var div = document.getElementById("envList");
	
	div.innerHTML = "";
	var str = '<table style="border:0;margin:0;padding:0;"><tr><td>';
	for(var i=0; i!=envList.length; i++) {
		str += '<input id="env_radio_'+i+'" class="environmentRadioButton" '
			+'type="radio" name="environment" value="'+envList[i]+'"'+(i==0?'checked':'')+' '
			+'onclick="refreshSelection()" '
			+'/>'
			+'<label for="env_radio_'+i+'" class="environmentLabel"><span >'+envList[i]+'</span></label>';
	
		if(i%2==0){
			str += "</td><td>";
		}
		else {
			str += "</td></tr><tr><td>";
		}
	}

	str += "</td></tr></table>";
	div.innerHTML = str;
	
}

function getSelectedEnvironment() {
	var radios = document.getElementsByName('environment');
	var length=radios.length;
	for (var i=0; i<length; i++) {
		if (radios[i].checked) {
			return radios[i].value;
		}
	}
	return null;
}

function drawRectangle(name, connectors, position) {
	
	//draw
	var x = parseInt(position.x);
	var y = parseInt(position.y);
	var h = parseInt(position.h);
	var w = parseInt(position.w);

	var r = document.createElementNS(svgNS, "rect");
	var t = document.createElementNS(svgNS, "text");
	var g = document.createElementNS(svgNS, "g");
	var fontSize = 20;
	
	r.setAttributeNS(null, "x", position.x);
	r.setAttributeNS(null, "y", position.y);
	r.setAttributeNS(null, "width", position.w);
	r.setAttributeNS(null, "height", position.h);
	//r.setAttributeNS(null, "style", "fill:white;stroke:black;stroke-width:5;");
	r.setAttributeNS(null, "style", "fill:white;stroke:black;");
		
	t.setAttributeNS(null, "x", parseInt(position.x)+parseInt(position.w)/2);
	t.setAttributeNS(null, "y", parseInt(position.y)+parseInt(position.h)/2+fontSize/2);
	t.setAttributeNS(null, "font-family", "Verdana");
	t.setAttributeNS(null, "font-size", fontSize);
	t.setAttributeNS(null, "fill", "black");
	t.setAttributeNS(null, "text-anchor", "middle");
	t.appendChild(document.createTextNode(name));

	r.onclick  = function()  { 
		// when the rectangle (module/externalApplication) is clicked

		setSelection(r, function(){ 
			var details = getRectangleDetails(getSelectedEnvironment(), name);
			showDetails(details, name);
		} );
	
		var envName = getSelectedEnvironment();
		var details = getRectangleDetails(getSelectedEnvironment(), name);
		showDetails(details, name);
	}
	
	g.appendChild(r);
	g.appendChild(t);
	addToSvg(g);
	
	// store in context
	var rectangle = {"x":x, "y":y, "w":w, "h":h};
	gRectangles[name] = rectangle;
	
	// add connectors
	if(connectors != null) {
		drawConnectors(rectangle, connectors, name);
	}
}

function addToSvg(o) {
	// todo : ca s'optimise ?
	document.getElementById("mysvg").appendChild(o);
}

function svgDefs() {
	var defs = document.createElementNS(svgNS, "defs");
	var marker = document.createElementNS(svgNS, "marker");
	var markerPath = document.createElementNS(svgNS, "path");
	marker.setAttributeNS(null, "id", "head");
	marker.setAttributeNS(null, "orient", "auto");
	marker.setAttributeNS(null, "markerWidth", "2");
	marker.setAttributeNS(null, "markerHeight", "4");
	marker.setAttributeNS(null, "refX", "2");
	marker.setAttributeNS(null, "refY", "2");
	markerPath.setAttributeNS(null, "d", "M0,0 V4 L2,2 Z");
	markerPath.setAttributeNS(null, "fill", "red");
	marker.appendChild(markerPath);
	defs.appendChild(marker);
	addToSvg(defs);
}

function drawLink(fromRectangle, toConnector) {
	/*var toX = toConnector.x;
	var toY = toConnector.y;
	
	var fromX = fromRectangle.x;
	var fromY = fromRectangle.y+fromRectangle.h/2;

	var fromOrientation = null;

	 tout horizontal
	// todo : on doit pouvoir faire une matrice de tout ça
	if(toConnector.orientation == "l") {
		if(toConnector.x < fromRectangle.x+fromRectangle.w) {
			fromOrientation = "l";
		}
		else {
			fromOrientation = "r";
		}
	}
	else {
		if(toConnector.x < fromRectangle.x) {
			fromOrientation = "l";
		}
		else {
			fromOrientation = "r";
		}
	}
	
	var fromX = (fromOrientation=="l" ? fromRectangle.x : fromRectangle.x+fromRectangle.w);
	var fromY = (fromRectangle.y+fromRectangle.h/2);
	if(fromOrientation == toConnector.orientation) {
		// C-shape
		var strPath = "M" + fromX + " " + fromY;
		strPath += " H" + (toX+(fromOrientation=="l"?-20:20));
		strPath += " V" + toConnector.y;
		strPath += " H" + toConnector.x;
	}
	else {
		// Z-shape
		var strPath = "M" + fromX + " " + fromY;
		strPath += " H" + ((fromX+toConnector.x)/2);
		strPath += " V" + toConnector.y;
		strPath += " H" + toConnector.x;
	}
	*/
	
	// THE matrice
	var matrice = { "l": [	[ "M${sx} $(syb} V${ey} H${ex}"							, "M${sx} ${syb} V${midy_b} H${exm} V${ey} H${ex}"],
							[ "M${sx} ${syb} V${sybp} H${midx_left} V${ey} H${ex}"	, "M${sx} ${syb} V${sybp} H${exm} ${ey} H${ex}"],
							[ "M${sx} ${syt} V${ey} H${ex}"							, "M${sx} ${syt} V${midy_t} H${exm} V${ey} H${ex}"] ],
					"r": [	["M${sx} ${syb} V${midy_b} H${exp} V${ey} H${ex}"		, "M${sx} ${syb} V${ey} H${ex}"],
							["M${sx} ${syb} V${sybp} H${exp} V${ey} H${ex}"			, "M${sx} ${syb} V${sybp} H${midx_right} V${ey} H${ex}"],
							["M${sx} ${syt} V${midy_t} H${exp} V${ey} H${ex}"		, "M${sx} ${syt} V${ey} H${ex}"] ] };
	
	var pattern = null;
	
	
	var ex = toConnector.x;
	var exm = ex-20;
	var exp = ex+20;
	var ey = toConnector.y;
	var sx = fromRectangle.x+fromRectangle.w/2;
	var syt = fromRectangle.y;
	var syb = fromRectangle.y+fromRectangle.h;
	var sytm = syt-20;
	var sybp = syb+20;
	var midy_t=(syt + ey)/2;
	var midy_b=(syb + ey)/2;
	var midx_left=(fromRectangle.x+fromRectangle.w+toConnector.x)/2
	var midx_right=(fromRectangle.x+toConnector.x)/2
	
	var i1 = (ey>syb?0:ey>syt?1:2);
	var i2 = (ex>sx?0:1);
	var strPath = matrice[toConnector.orientation][i1][i2];
	
	var strPath = strPath.replace("${ex}", ex);
	var strPath = strPath.replace("${exm}", exm);
	var strPath = strPath.replace("${exp}", exp);
	var strPath = strPath.replace("${ey}", ey);
	var strPath = strPath.replace("${sx}", sx);
	var strPath = strPath.replace("${syt}", syt);
	var strPath = strPath.replace("${syb}", syb);
	var strPath = strPath.replace("${sytm}", sytm);
	var strPath = strPath.replace("${sybp}", sybp);
	var strPath = strPath.replace("${midy_t}", midy_t);
	var strPath = strPath.replace("${midy_b}", midy_b);
	var strPath = strPath.replace("${midx_left}", midx_left);
	var strPath = strPath.replace("${midx_right}", midx_right);

	var p = document.createElementNS(svgNS, "path");
	p.setAttributeNS(null, "marker-end", "url(#head)");
	p.setAttributeNS(null, "fill", "none");
	p.setAttributeNS(null, "stroke", "blue");
	p.setAttributeNS(null, "stroke-width", "5");
	p.setAttributeNS(null, "d", strPath);
	addToSvg(p);
	
}

function showLinks() {
	/*

	var p = document.createElementNS(svgNS, "path");
	p.setAttributeNS(null, "marker-end", "url(#head)");
	p.setAttributeNS(null, "fill", "none");
	p.setAttributeNS(null, "stroke", "blue");
	p.setAttributeNS(null, "stroke-width", "5");
	p.setAttributeNS(null, "d", "M100 100 H140 V140 H180 V180");

	addToSvg(p);*/
	
	var links = envDescription.links;
	for(var i=0; i!=links.length; i++) {
		var link = links[i];
	
		var fromName = link.from;
		var toName = link.to;
		var toConnectorName = link.connector;

		var fromRectangle = gRectangles[fromName];
		var toConnector = gConnectors[toName+gSep+toConnectorName];
		
		drawLink(fromRectangle, toConnector);
	}

}

function drawConnectors(rectangle, connectors, namePrefix) {
	if(connectors == null) {
		return;
	}

	var width = 8;
	var n = Object.keys(connectors).length;
	
	var orientedConnectors = {};
	for(var i=0; i!=Object.keys(orientationEnum).length; i++) {
		var orientationName = Object.keys(orientationEnum)[i];
		orientedConnectors[orientationName] = [];
	}

	for(var i=0; i!=n; i++) {
		connectorName = Object.keys(connectors)[i];
		connector = connectors[connectorName];
		connector.name = connectorName;
		orientedConnectors[connector.orientation].push(connector);
	}
	
	for(var i=0; i!=Object.keys(orientedConnectors).length; i++) {
		var orientationName = Object.keys(orientedConnectors)[i];
		var orientation = orientationEnum[orientationName];
		var connectorList = orientedConnectors[orientationName]
		
		for(var j=0; j!=connectorList.length; j++) {
			// todo : up and down orientation
			var connector = connectorList[j];
			
			if(orientation == "r") {
				var y = rectangle.y + rectangle.h*(j+1)/(connectorList.length+1);
				var x = rectangle.x + rectangle.w;
			}
			else {
				var y = rectangle.y + rectangle.h*(j+1)/(connectorList.length+1);
				var x = rectangle.x;
			}
			
			drawConnector(namePrefix+gSep+connector.name, 
						connector.name,
						x, 
						y, 
						width, 
						orientation)
		}
	}
}

function drawConnector(name, shortName, x, y, w, orientation) {
	
	// draw
	var r = document.createElementNS(svgNS, "rect");
	r.setAttributeNS(null, "x", x-w/2);
	r.setAttributeNS(null, "y", y-w/2);
	r.setAttributeNS(null, "width", w);
	r.setAttributeNS(null, "height", w);
	r.setAttributeNS(null, "style", "fill:white;stroke:black;");
	
	var fontSize = 11;
	
	var t = document.createElementNS(svgNS, "text");
	t.setAttributeNS(null, "x", (orientation=="l"?x+w:x-w));
	t.setAttributeNS(null, "y", y);
	t.setAttributeNS(null, "font-family", "Verdana");
	t.setAttributeNS(null, "font-size", fontSize);
	t.setAttributeNS(null, "font-tyle", "italic");
	t.setAttributeNS(null, "fill", "black");
	t.setAttributeNS(null, "text-anchor", (orientation=="l"?"start":"end") );
	t.appendChild(document.createTextNode(shortName));

	r.onclick = t.onclick = function()  { 
		// when the connector is clicked
		var splt = name.split(gSep);
		var moduleName = splt[0];
		var connectorName = splt[1];

		setSelection(r, function(){ 
			var details = getConnectorDetails(getSelectedEnvironment(), moduleName, connectorName);
			showDetails(details, moduleName+" - "+connectorName);
		} );
	
		var envName = getSelectedEnvironment();
		var details = getConnectorDetails(envName, moduleName, connectorName);
		showDetails(details, moduleName+" - "+connectorName);
	}
	
	addToSvg(r);
	addToSvg(t);

	// store in context
	gConnectors[name] = {"x":x, "y":y, "w":w, "orientation":orientation};

}

function getRectangleDetails(envName, name) {
	var myenv = envDetails[envName];
	if(myenv == null) {
		return null;
	}
	var myapplication = myenv.application;
	if(myapplication == null) {
		return null;
	}
	var modules = myapplication.modules;
	var externalApplications = myenv.externalApplications;
	
	if(modules!=null && modules[name] != null) {
		return modules[name];
	}
	else if(externalApplications!=null && externalApplications[name] != null) {
		return externalApplications[name];
	}
}


function getConnectorDetails(envName, moduleName, connectorName) {
	var myenv = envDetails[envName];
	if(myenv == null) {
		return null;
	}
	var myapplication = myenv.application;
	if(myapplication == null) {
		return null;
	}
	var modules = myapplication.modules;
	var externalApplications = myenv.externalApplications;
	
	if(modules!=null && modules[moduleName] != null) {
		return modules[moduleName].connectors[connectorName];
	}
	else if(externalApplications!=null && externalApplications[moduleName] != null) {
		return externalApplications[moduleName].connectors[connectorName];
	}
}

function getFormatedValue(value) {
	if(value.startsWith("http://") ||
		value.startsWith("https://")) {
		var a = document.createElement("a");
		a.href = value;
		a.appendChild(document.createTextNode(value));
		return a;
	}
	
	return document.createTextNode(value);
};

function showDetails(o, title) {
	var mydiv = document.getElementById("mydetails");
	mydiv.innerHTML = "";
	
	if(title != null) {
		var d = document.createElement("div");
		d.appendChild(document.createTextNode(title));
		d.className = "detailsTitle";
		mydiv.appendChild(d);
	}

	if(o == null) {
		mydiv.appendChild(document.createTextNode("Nothing to display."));
	}
	else {
		
		var t = document.createElement("table");
		t.className = "detailsTable";
		
		//alert(Object.keys(o).length + "details to display");
		for(var i=0; i!=Object.keys(o).length; i++) {
			var detailName = Object.keys(o)[i];
			var detailValue = o[detailName];
			
			if((typeof detailValue)=="string") {
				var tr = document.createElement("tr");
				var td1 = document.createElement("td");
				var td2 = document.createElement("td");
				
				td1.appendChild(document.createTextNode(detailName));
				td2.appendChild(getFormatedValue(detailValue));
				tr.appendChild(td1);
				tr.appendChild(td2);
				t.appendChild(tr);
				mydiv.appendChild(t);
			}			
		}
	}
}


function showApplication() {
	var application = envDescription.application;
	var modules = application.modules;
	var positioning = envDescription.positioning;

	for(var i=0; i!=Object.keys(modules).length; i++) {
		var moduleName = Object.keys(modules)[i];
		var module = modules[moduleName];
		var position = positioning[moduleName];
		
		drawRectangle(moduleName, module.connectors, position)
	}
}

function showExternalApplications() {
	var externalApplications = envDescription.externalApplications;
	var positioning = envDescription.positioning;

	for(var i=0; i!=Object.keys(externalApplications).length; i++) {
		var externalApplicationName = Object.keys(externalApplications)[i];
		var externalApplication = externalApplications[externalApplicationName];
		var position = positioning[externalApplicationName];
		
		drawRectangle(externalApplicationName, externalApplication.connectors, position);
	}

}

function myBodyOnload() {
	svgDefs();
	showEnvList();
	showApplication();
	showExternalApplications();
	showLinks();

	/*var mysvg = document.getElementById("mysvg");
	
	var mycercle = document.createElementNS(svgNS, "circle");
	mycercle.setAttributeNS(null, "cx", "200");
	mycercle.setAttributeNS(null, "cy", "200");
	mycercle.setAttributeNS(null, "r", "20");
	mycercle.setAttributeNS(null, "stroke", "red");
	mycercle.setAttributeNS(null, "fill", "green");
	mycercle.setAttributeNS(null, "stroke-width", "10");

	var mycercle2 = document.createElementNS(svgNS, "circle");
	mycercle2.setAttributeNS(null, "cx", "100");
	mycercle2.setAttributeNS(null, "cy", "150");
	mycercle2.setAttributeNS(null, "r", "50");
	mycercle2.setAttributeNS(null, "stroke", "grey");
	mycercle2.setAttributeNS(null, "fill", "blue");
	mycercle2.setAttributeNS(null, "stroke-width", "40");
	
	mysvg.appendChild(mycercle);
	mysvg.appendChild(mycercle2);*/
}


</script>
</head>
<body onload="myBodyOnload();">

<table><tr><td style="width:400px;vertical-align:top;height:1%;" >
    <div id="envList"/>


</td><td rowspan="2">

<svg id="mysvg" height="600" width="900" 
 xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"/>
 
</svg> 

</td></tr>
<tr><td style="vertical-align:top;">
<div id="mydetails">
	...
</div>
</td></tr></table>

</body>
</html> 